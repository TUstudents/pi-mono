name: Sync Upstream

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:      # Manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.SYNC_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: git remote add upstream https://github.com/badlogic/pi-mono.git

      - name: Fetch upstream
        run: git fetch upstream main

      - name: Check if up-to-date
        id: check
        run: |
          UPSTREAM_COMMITS=$(git rev-list HEAD..upstream/main --count)
          echo "upstream_commits=$UPSTREAM_COMMITS" >> $GITHUB_OUTPUT
          if [ "$UPSTREAM_COMMITS" -eq 0 ]; then
            echo "Already up-to-date with upstream"
          else
            echo "Found $UPSTREAM_COMMITS new commit(s) from upstream"
          fi

      - name: Merge upstream with auto-resolve
        id: merge
        if: steps.check.outputs.upstream_commits != '0'
        run: |
          # Attempt merge
          if git merge upstream/main --no-edit; then
            echo "merge_status=success" >> $GITHUB_OUTPUT
          else
            echo "Conflicts detected, auto-resolving..."

            # Get list of conflicted files
            CONFLICTS=$(git diff --name-only --diff-filter=U)
            echo "Conflicted files: $CONFLICTS"

            # Resolve conflicts by accepting upstream for package files, then rebranding
            for file in $CONFLICTS; do
              if [[ "$file" == *"package.json" ]] || [[ "$file" == *"package-lock.json" ]]; then
                echo "Resolving $file by accepting upstream version..."
                git checkout --theirs "$file" || true
              else
                # For other files, try to accept upstream
                git checkout --theirs "$file" || true
              fi
            done

            echo "merge_status=resolved" >> $GITHUB_OUTPUT
          fi

      - name: Apply branding customizations
        if: steps.merge.outputs.merge_status == 'resolved'
        run: |
          echo "Applying @cargo-cult branding..."

          # Re-apply scope changes to all relevant files
          find packages -name "package.json" | while read f; do
            sed -i 's/@mariozechner\/pi-ai/@cargo-cult\/pi-ai/g' "$f"
            sed -i 's/@mariozechner\/pi-tui/@cargo-cult\/pi-tui/g' "$f"
            sed -i 's/@mariozechner\/pi-agent-core/@cargo-cult\/pi-agent-core/g' "$f"
            sed -i 's/@mariozechner\/pi-coding-agent/@cargo-cult\/pi-coding-agent/g' "$f"
            sed -i 's/@mariozechner\/pi-mom/@cargo-cult\/pi-mom/g' "$f"
            sed -i 's/@mariozechner\/pi-web-ui/@cargo-cult\/pi-web-ui/g' "$f"
            sed -i 's/"@mariozechner\/pi"/"@cargo-cult\/pi"/g' "$f"
            sed -i 's/badlogic\/pi-mono/TUstudents\/pi-mono/g' "$f"
          done

          # Re-apply to source files that may have been updated
          find packages -name "*.ts" -o -name "*.tsx" -o -name "*.js" | xargs -r sed -i \
            -e 's/@mariozechner\/pi-ai/@cargo-cult\/pi-ai/g' \
            -e 's/@mariozechner\/pi-tui/@cargo-cult\/pi-tui/g' \
            -e 's/@mariozechner\/pi-agent-core/@cargo-cult\/pi-agent-core/g' \
            -e 's/@mariozechner\/pi-coding-agent/@cargo-cult\/pi-coding-agent/g' \
            -e 's/@mariozechner\/pi-mom/@cargo-cult\/pi-mom/g' \
            -e 's/@mariozechner\/pi-web-ui/@cargo-cult\/pi-web-ui/g'

          # Re-apply to markdown and config files
          find packages -name "*.md" -o -name "tsconfig*.json" | xargs -r sed -i \
            -e 's/@mariozechner\/pi-ai/@cargo-cult\/pi-ai/g' \
            -e 's/@mariozechner\/pi-tui/@cargo-cult\/pi-tui/g' \
            -e 's/@mariozechner\/pi-agent-core/@cargo-cult\/pi-agent-core/g' \
            -e 's/@mariozechner\/pi-coding-agent/@cargo-cult\/pi-coding-agent/g' \
            -e 's/@mariozechner\/pi-mom/@cargo-cult\/pi-mom/g' \
            -e 's/@mariozechner\/pi-web-ui/@cargo-cult\/pi-web-ui/g' \
            -e 's/badlogic\/pi-mono/TUstudents\/pi-mono/g'

          # Update root files
          sed -i \
            -e 's/@mariozechner\/pi-ai/@cargo-cult\/pi-ai/g' \
            -e 's/@mariozechner\/pi-tui/@cargo-cult\/pi-tui/g' \
            -e 's/@mariozechner\/pi-agent-core/@cargo-cult\/pi-agent-core/g' \
            -e 's/@mariozechner\/pi-coding-agent/@cargo-cult\/pi-coding-agent/g' \
            -e 's/@mariozechner\/pi-mom/@cargo-cult\/pi-mom/g' \
            -e 's/@mariozechner\/pi-web-ui/@cargo-cult\/pi-web-ui/g' \
            -e 's/"@mariozechner\/pi"/"@cargo-cult\/pi"/g' \
            -e 's/badlogic\/pi-mono/TUstudents\/pi-mono/g' \
            package.json tsconfig.json scripts/sync-versions.js 2>/dev/null || true

          # Ensure web-ui has repository field (npm provenance requires it)
          if ! grep -q '"repository"' packages/web-ui/package.json; then
            sed -i '/"license": "MIT"/a\  ,"repository": {\n    "type": "git",\n    "url": "git+https://github.com/TUstudents/pi-mono.git",\n    "directory": "packages/web-ui"\n  }' packages/web-ui/package.json
          fi

      - name: Setup Node.js
        if: steps.merge.outputs.merge_status == 'resolved'
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install system dependencies
        if: steps.merge.outputs.merge_status == 'resolved'
        run: |
          sudo apt-get update
          sudo apt-get install -y libcairo2-dev libpango1.0-dev libjpeg-dev libgif-dev librsvg2-dev

      - name: Regenerate lock file and build
        if: steps.merge.outputs.merge_status == 'resolved'
        run: |
          # Remove lock files and regenerate
          rm -f package-lock.json packages/coding-agent/examples/extensions/with-deps/package-lock.json
          npm install

          # Build to ensure everything compiles
          npm run build

      - name: Commit resolved merge
        if: steps.merge.outputs.merge_status == 'resolved'
        run: |
          git add -A
          git commit -m "Merge upstream changes with @cargo-cult branding"

      - name: Push changes
        if: steps.merge.outputs.merge_status == 'success' || steps.merge.outputs.merge_status == 'resolved'
        run: git push origin main

      - name: Create release tag
        if: steps.merge.outputs.merge_status == 'success' || steps.merge.outputs.merge_status == 'resolved'
        run: |
          # Get current version from package.json
          VERSION=$(node -p "require('./packages/coding-agent/package.json').version")
          TAG_NAME="v${VERSION}-sync.$(date +%Y%m%d%H%M%S)"
          git tag "$TAG_NAME"
          git push origin "$TAG_NAME"
          echo "Created and pushed tag: $TAG_NAME"

      - name: Trigger npm publish for new tag
        if: steps.merge.outputs.merge_status == 'success' || steps.merge.outputs.merge_status == 'resolved'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.SYNC_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'npm-publish.yml',
              ref: '${{ steps.tags.outputs.new_tag }}'
            });
            console.log('Triggered npm publish for tag: ${{ steps.tags.outputs.new_tag }}');
